<div class="page">
  <div class="titlebar">
    <h1>Debtor Aging</h1>
    <div class="toolbar">
      <button class="btn" (click)="inquiry()"><span class="ico refresh"></span> Inquiry</button>
      <button class="btn" (click)="preview()"><span class="ico eye"></span> Preview</button>
      <button class="btn" (click)="print()"><span class="ico print"></span> Print</button>
      <button class="btn" (click)="toggleOptions()">{{ showOptions ? 'Hide Options' : 'Show Options' }}</button>
    </div>
  </div>

  <!-- Options -->
  <div class="options" *ngIf="showOptions">
    <form [formGroup]="fg" class="opt-grid">
      <fieldset>
        <legend>Date & Filter</legend>
        <label>As at <input type="date" formControlName="asOf"></label>
        <label>Debtor <input formControlName="debtor" placeholder="Filter by code or name"></label>
      </fieldset>

      <fieldset>
        <legend>Options</legend>
        <label>Bucket size (days)
          <input type="number" min="15" step="5" formControlName="bucketSize">
        </label>
        <label>Group by
          <select formControlName="groupBy">
            <option value="none">None</option>
            <option value="salesAgent">Sales Agent</option>
          </select>
        </label>
        <label class="chk">
          <input type="checkbox" formControlName="includeZero"> Include zero-balance
        </label>
        <label class="chk">
          <input type="checkbox" formControlName="showCriteria"> Show Criteria in Report
        </label>
      </fieldset>
    </form>
  </div>

  <!-- Grid (no group) -->
  <div class="gridwrap" *ngIf="fg.value.groupBy==='none'">
    <table>
      <thead>
        <tr>
          <th>Debtor</th>
          <th class="r">Current</th>
          <th class="r">1–{{ fg.value.bucketSize }}</th>
          <th class="r">{{ fg.value.bucketSize!+1 }}–{{ fg.value.bucketSize!*2 }}</th>
          <th class="r">{{ fg.value.bucketSize!*2+1 }}–{{ fg.value.bucketSize!*3 }}</th>
          <th class="r">&gt;{{ fg.value.bucketSize!*3 }}</th>
          <th class="r">Total</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of agingLines()">
          <td>{{ r.debtorCode }} — {{ r.debtorName }}</td>
          <td class="r">{{ r.current  | number:'1.2-2' }}</td>
          <td class="r">{{ r.d1_30    | number:'1.2-2' }}</td>
          <td class="r">{{ r.d31_60   | number:'1.2-2' }}</td>
          <td class="r">{{ r.d61_90   | number:'1.2-2' }}</td>
          <td class="r">{{ r.over90   | number:'1.2-2' }}</td>
          <td class="r"><strong>{{ r.total | number:'1.2-2' }}</strong></td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Grid (grouped by agent) -->
  <div class="gridwrap" *ngIf="fg.value.groupBy!=='none'">
    <table>
      <thead>
        <tr>
          <th>Debtor (Group: Sales Agent)</th>
          <th class="r">Current</th>
          <th class="r">1–{{ fg.value.bucketSize }}</th>
          <th class="r">{{ fg.value.bucketSize!+1 }}–{{ fg.value.bucketSize!*2 }}</th>
          <th class="r">{{ fg.value.bucketSize!*2+1 }}–{{ fg.value.bucketSize!*3 }}</th>
          <th class="r">&gt;{{ fg.value.bucketSize!*3 }}</th>
          <th class="r">Total</th>
        </tr>
      </thead>

      <ng-container *ngFor="let g of grouped()">
        <tbody class="group-head">
          <tr><td colspan="7">Group: <strong>{{ g.key }}</strong></td></tr>
        </tbody>
        <tbody>
          <tr *ngFor="let r of g.items">
            <td>{{ r.debtorCode }} — {{ r.debtorName }}</td>
            <td class="r">{{ r.current  | number:'1.2-2' }}</td>
            <td class="r">{{ r.d1_30    | number:'1.2-2' }}</td>
            <td class="r">{{ r.d31_60   | number:'1.2-2' }}</td>
            <td class="r">{{ r.d61_90   | number:'1.2-2' }}</td>
            <td class="r">{{ r.over90   | number:'1.2-2' }}</td>
            <td class="r"><strong>{{ r.total | number:'1.2-2' }}</strong></td>
          </tr>
        </tbody>
        <tbody class="group-total">
          <tr>
            <td class="r"><strong>Subtotal</strong></td>
            <td class="r"><strong>{{ g.totals.current  | number:'1.2-2' }}</strong></td>
            <td class="r"><strong>{{ g.totals.d1_30    | number:'1.2-2' }}</strong></td>
            <td class="r"><strong>{{ g.totals.d31_60   | number:'1.2-2' }}</strong></td>
            <td class="r"><strong>{{ g.totals.d61_90   | number:'1.2-2' }}</strong></td>
            <td class="r"><strong>{{ g.totals.over90   | number:'1.2-2' }}</strong></td>
            <td class="r"><strong>{{ g.totals.total    | number:'1.2-2' }}</strong></td>
          </tr>
        </tbody>
      </ng-container>
    </table>
  </div>

  <!-- Grand totals -->
  <div class="totals">
    <div class="row"><span>Current</span><strong>{{ totals().current  | number:'1.2-2' }}</strong></div>
    <div class="row"><span>1–{{ fg.value.bucketSize }}</span><strong>{{ totals().d1_30 | number:'1.2-2' }}</strong></div>
    <div class="row"><span>{{ fg.value.bucketSize!+1 }}–{{ fg.value.bucketSize!*2 }}</span><strong>{{ totals().d31_60 | number:'1.2-2' }}</strong></div>
    <div class="row"><span>{{ fg.value.bucketSize!*2+1 }}–{{ fg.value.bucketSize!*3 }}</span><strong>{{ totals().d61_90 | number:'1.2-2' }}</strong></div>
    <div class="row"><span>&gt;{{ fg.value.bucketSize!*3 }}</span><strong>{{ totals().over90 | number:'1.2-2' }}</strong></div>
    <div class="row final"><span>Total</span><strong>{{ totals().total | number:'1.2-2' }}</strong></div>
  </div>

  <!-- Preview box -->
  <div *ngIf="showPreview()" class="previewbox">
    <h3>Preview – Debtor Aging</h3>
    <div *ngIf="fg.value.showCriteria" class="criteria">
      <strong>As at:</strong> {{ fg.value.asOf }} &nbsp;|&nbsp;
      <strong>Bucket:</strong> {{ fg.value.bucketSize }} days &nbsp;|&nbsp;
      <strong>Group:</strong> {{ fg.value.groupBy }}
    </div>
  </div>
</div>
