<div class="page">
  <!-- Header / Toolbar -->
  <div class="titlebar">
    <h1>Stock Value Maintenance</h1>

    <div class="toolbar">
      <input class="search" [(ngModel)]="q" placeholder="Search item / warehouse / remark..." />
      <button class="btn" (click)="onNew()">New</button>
      <button class="btn" [disabled]="!selected" (click)="onEdit()">Edit</button>
      <button class="btn danger" [disabled]="!selected" (click)="onDelete()">Delete</button>
      <span class="sp"></span>
      <button class="btn" (click)="onImport()">Import</button>
      <button class="btn" (click)="onExport()">Export</button>
      <button class="btn" (click)="onRefresh()">Refresh</button>
      <button class="btn" (click)="onPrint()">Print</button>
    </div>
  </div>

  <!-- Grid -->
  <div class="gridwrap">
    <table>
      <thead>
        <tr>
          <th style="width:160px">Item Code</th>
          <th>Item Name</th>
          <th style="width:110px">UOM</th>
          <th style="width:170px">Warehouse</th>
          <th style="width:130px">As of</th>
          <th class="text-end" style="width:130px">Qty</th>
          <th class="text-end" style="width:150px">Unit Cost</th>
          <th class="text-end" style="width:160px">Stock Value</th>
          <th>Remark</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let r of filtered(); trackBy: trackByKey"
            (click)="pick(r)"
            [class.active]="isPicked(r)">
          <td class="monospace">{{ r.itemCode }}</td>
          <td class="cut">{{ r.itemName }}</td>
          <td>{{ r.uom }}</td>
          <td>{{ r.warehouse }}</td>
          <td>{{ r.asOf }}</td>
          <td class="text-end">{{ r.qty | number:'1.0-3' }}</td>
          <td class="text-end">{{ r.unitCost | number:'1.2-4' }}</td>
          <td class="text-end"><b>{{ r.value | number:'1.2-2' }}</b></td>
          <td class="cut">{{ r.remark }}</td>
        </tr>
      </tbody>

      <tfoot>
        <tr>
          <td colspan="5" class="text-end"><b>Totals</b></td>
          <td class="text-end"><b>{{ totalQty() | number:'1.0-3' }}</b></td>
          <td></td>
          <td class="text-end"><b>{{ totalValue() | number:'1.2-2' }}</b></td>
          <td></td>
        </tr>
      </tfoot>
    </table>

    <div class="footer">Records: {{ filtered().length }}</div>
  </div>
</div>

<!-- Modal -->
<div class="modal-layer" *ngIf="showModal">
  <div class="modal-panel" role="dialog" aria-modal="true">
    <div class="modal-header">
      <div class="modal-title">{{ isEdit ? 'Edit Stock Value' : 'New Stock Value' }}</div>
      <button class="x" (click)="close()">✕</button>
    </div>

    <div class="modal-body">
      <div class="form">
        <label>Item Code</label>
        <select class="inp" [(ngModel)]="form.itemCode" (change)="onItemChange()" [disabled]="isEdit">
          <option value="">-- Select --</option>
          <option *ngFor="let it of items" [value]="it.code">{{ it.code }} — {{ it.name }}</option>
        </select>

        <label>Item Name</label>
        <input class="inp" [(ngModel)]="form.itemName" readonly />

        <label>UOM</label>
        <input class="inp" [(ngModel)]="form.uom" readonly />

        <label>Warehouse</label>
        <select class="inp" [(ngModel)]="form.warehouse">
          <option *ngFor="let w of warehouses" [value]="w">{{ w }}</option>
        </select>

        <label>As of Date</label>
        <input class="inp" type="date" [(ngModel)]="form.asOf" />

        <label>Quantity</label>
        <input class="inp num" type="number" step="0.001" [(ngModel)]="form.qty" (input)="normalizeNumbers()" />

        <label>Unit Cost</label>
        <input class="inp num" type="number" step="0.0001" [(ngModel)]="form.unitCost" (input)="normalizeNumbers()" />

        <label>Stock Value</label>
        <input class="inp num" [value]="form.value | number:'1.2-2'" readonly />

        <label>Remark</label>
        <input class="inp" [(ngModel)]="form.remark" placeholder="Optional" />
      </div>

      <div class="note">
        Stock Value = Qty × Unit Cost. Dùng để điều chỉnh giá trị tồn kho tại thời điểm “As of”.
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn ghost" (click)="close()">Cancel</button>
      <button class="btn primary" (click)="save()">Save</button>
    </div>
  </div>
</div>
