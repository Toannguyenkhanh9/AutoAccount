<div class="page">
  <div class="titlebar">
    <h1>A/P Credit Note Entry</h1>
    <div class="panel-actions">
      <button class="pill" (click)="openNew()">New</button>
      <button class="pill" [disabled]="!selected" (click)="openEdit(selected!)">Edit</button>
      <button class="pill" [disabled]="!selected" (click)="openView(selected!)">View</button>
      <button class="pill danger" [disabled]="!selected" (click)="delete(selected!)">Delete</button>
      <input class="pill-input" placeholder="Search doc no / creditor..." [(ngModel)]="q">
    </div>
  </div>

  <div class="gridwrap">
    <table>
      <thead>
        <tr>
          <th>Doc No</th>
          <th>Date</th>
          <th>Creditor</th>
          <th>Curr</th>
          <th class="text-end">Rate</th>
          <th class="text-end">Local Total</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of filtered()"
            (click)="selected = r"
            [class.selected]="selected?.docNo === r.docNo">
          <td>{{ r.docNo }}</td>
          <td>{{ r.date }}</td>
          <td>{{ r.creditorCode }} â€” {{ r.creditorName }}</td>
          <td>{{ r.currency }}</td>
          <td class="text-end">{{ r.rate | number:'1.2-4' }}</td>
          <td class="text-end">{{ r.localTotal | number:'1.2-2' }}</td>
          <td>{{ r.status }}</td>
        </tr>
      </tbody>
    </table>

    <div class="pager">
      <button class="btn" (click)="page = Math.max(1, page-1)">&laquo;</button>
      <span>Page {{ page }} / {{ pageCount() }}</span>
      <button class="btn" (click)="page = Math.min(pageCount(), page+1)">&raquo;</button>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal-backdrop" *ngIf="show" (click)="close()">
  <div class="modal-panel" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title">A/P Credit Note â€” {{ viewMode | uppercase }}</div>
      <button class="icon-btn" (click)="close()" aria-label="Close">âœ•</button>
    </div>

    <div class="modal-body">
      <form [formGroup]="form" class="form">
        <div class="form-grid">
          <div>
            <label>Date</label>
            <input type="date" formControlName="date" />
          </div>
          <div>
            <label>Creditor Code</label>
            <select formControlName="creditorCode" (change)="onCreditorChange()">
              <option [ngValue]="null">-- Select --</option>
              <option *ngFor="let c of creditors" [ngValue]="c.code">{{ c.code }}</option>
            </select>
          </div>
          <div>
            <label>Creditor Name</label>
            <input type="text" formControlName="creditorName" />
          </div>
          <div>
            <label>Rate</label>
            <input type="number" step="0.0001" formControlName="rate" />
          </div>
          <div>
            <label>Status</label>
            <select formControlName="status">
              <option value="DRAFT">DRAFT</option>
              <option value="POSTED">POSTED</option>
            </select>
          </div>
          <div class="full">
            <label>Remark</label>
            <input type="text" formControlName="remark" />
          </div>
        </div>

        <table class="lines-table">
          <thead>
            <tr>
              <th style="width:140px;">UOM</th>
              <th style="width:120px;">Qty</th>
              <th style="width:160px;">Unit Price</th>
              <th style="width:120px;">Tax %</th>
              <th class="text-end" style="width:160px;">Amount</th>
              <th style="width:60px;">
                <button type="button" class="icon-btn" (click)="addLine()" title="Add line">ï¼‹</button>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let g of lineGroups; let i = index" [formGroup]="g">
              <td><input type="text" formControlName="uom" /></td>
              <td><input type="number" formControlName="qty" step="1" /></td>
              <td><input type="number" formControlName="unitPrice" step="0.01" /></td>
              <td><input type="number" formControlName="tax" step="0.01" /></td>
              <td class="text-end">{{ g.get('amount')?.value | number:'1.2-2' }}</td>
              <td><button type="button" class="icon-btn" (click)="removeLine(i)" title="Remove">ðŸ—‘</button></td>
            </tr>
          </tbody>
        </table>

        <div class="total-row">
          <div>Total</div>
          <div>{{ computeTotal() | number:'1.2-2' }}</div>
        </div>
      </form>
    </div>

    <div class="modal-footer" *ngIf="viewMode !== 'view'">
      <button class="btn" (click)="close()">Cancel</button>
      <button class="btn primary" (click)="save()">Save</button>
    </div>
    <div class="modal-footer" *ngIf="viewMode === 'view'">
      <button class="btn" (click)="close()">Close</button>
    </div>
  </div>
</div>
